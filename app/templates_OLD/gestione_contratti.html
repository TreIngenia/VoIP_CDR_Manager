
    <h1>Gestione Contratti CDR</h1>
    <p>Totale contratti: <span id="total-contracts">0</span></p>
    <p>Ultimo aggiornamento: <span id="last-updated">-</span></p>
    
    <div id="loading">Caricamento contratti...</div>
    <div id="error" style="color: red; display: none;"></div>
    
    <form id="contracts-form" style="display: none;">
        <div class="table-responsive">
            <table class="table table-rounded table-striped border gy-7 gs-7">
                <thead>
                    <tr class="fw-semibold fs-6 text-gray-800 border-bottom border-gray-200">
                        <th>ID Contratto</th>
                        <th>N. Telefono</th>
                        <th>Nome Cliente</th>
                        <th>Codice Odoo</th>
                        <th>Note</th>
                        <th>Azione</th>
                    </tr>
                </thead>
                <tbody id="contracts-container">
                    
                </tbody>
            </table>
        </div>

        <div style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 20px;">
            <button type="button" onclick="saveAllContracts()">Salva Tutti i Contratti</button>
            <button type="button" onclick="loadContracts()">Ricarica Dati</button>
            <span id="save-status" style="margin-left: 20px;"></span>
        </div>
    </form>

    <script>
        let contractsData = {};
        
        // Carica contratti all'avvio
        document.addEventListener('DOMContentLoaded', function() {
            loadContracts();
        });
        
        async function loadContracts() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const form = document.getElementById('contracts-form');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            form.style.display = 'none';
            
            try {
                const response = await fetch('/api/cdr/contracts_config');
                const data = await response.json();
                
                if (data.success) {
                    contractsData = data.data;
                    displayContracts(contractsData.contracts);
                    
                    document.getElementById('total-contracts').textContent = data.contracts_count;
                    document.getElementById('last-updated').textContent = new Date(data.last_updated).toLocaleString('it-IT');
                    
                    loading.style.display = 'none';
                    form.style.display = 'block';
                } else {
                    throw new Error(data.message || 'Errore nel caricamento');
                }
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'Errore nel caricamento dei contratti: ' + err.message;
            }
        }
        
        function displayContracts(contracts) {
            const container = document.getElementById('contracts-container');
            container.innerHTML = '';
            
            // Ordina contratti per codice (numericamente)
            const sortedContracts = Object.entries(contracts).sort((a, b) => {
                return parseInt(a[0]) - parseInt(b[0]);
            });
            
            sortedContracts.forEach(([contractCode, contract]) => {
                const contractDiv = document.createElement('tr');
                
                contractDiv.innerHTML = `
                			<tr>
                                <td>${contractCode}</td>
                                <td><input type="text" 
                                       value="${contract.phone_numbers || ''}" 
                                       placeholder="Inserisci nome cliente"
                                       class="disabled" disabled
                                       ></td>
                                <td>
                                    <input type="text" 
                                       id="name_${contractCode}" 
                                       name="name_${contractCode}"
                                       value="${contract.contract_name || ''}" 
                                       placeholder="Inserisci nome cliente">
                                </td>
                                <td>
                                <input type="number" 
                                       id="odoo_${contractCode}" 
                                       name="odoo_${contractCode}"
                                       value="${contract.odoo_client_id || ''}" 
                                       placeholder="Inserisci ID cliente Odoo">
                                </td>
                                <td>
                                    <textarea id="notes_${contractCode}" 
                                          name="notes_${contractCode}"
                                          placeholder="Note aggiuntive"
                                          rows="1"
                                          style="resize: vertical;">${contract.notes || ''}</textarea>
                                </td>
                                <td>
                                    <button type="button" 
                                            onclick="saveContract('${contractCode}')"
                                            style="padding: 8px 15px; background: #007cba; color: white; border: none; cursor: pointer;">
                                        Salva Contratto ${contractCode}
                                    </button>
                                    <span id="status_${contractCode}" style="margin-left: 10px; font-size: 0.9em;"></span>
                                </td>
                            </tr>
                
                    
      
                    
                    
                `;
                
                container.appendChild(contractDiv);
            });
        }
        
        async function saveContract(contractCode) {
            const statusElement = document.getElementById(`status_${contractCode}`);
            statusElement.textContent = 'Salvando...';
            statusElement.style.color = 'blue';
            
            const contractName = document.getElementById(`name_${contractCode}`).value.trim();
            const odooClientId = document.getElementById(`odoo_${contractCode}`).value.trim();
            const notes = document.getElementById(`notes_${contractCode}`).value.trim();
            
            const updateData = {
                contract_code: contractCode,
                contract_name: contractName,
                notes: notes
            };
            
            // Aggiungi odoo_client_id solo se ha un valore
            if (odooClientId) {
                updateData.odoo_client_id = parseInt(odooClientId);
            }
            
            try {
                const response = await fetch('/api/cdr/update_contract', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusElement.textContent = '✅ Salvato con successo';
                    statusElement.style.color = 'green';
                    
                    // Rimuovi il messaggio dopo 3 secondi
                    setTimeout(() => {
                        statusElement.textContent = '';
                    }, 3000);
                } else {
                    throw new Error(result.message || 'Errore nel salvataggio');
                }
            } catch (error) {
                statusElement.textContent = '❌ Errore: ' + error.message;
                statusElement.style.color = 'red';
            }
        }
        
        async function saveAllContracts() {
            const saveStatus = document.getElementById('save-status');
            saveStatus.textContent = 'Salvataggio in corso...';
            saveStatus.style.color = 'blue';
            
            let successCount = 0;
            let errorCount = 0;
            
            const contracts = Object.keys(contractsData.contracts);
            
            for (const contractCode of contracts) {
                try {
                    const contractName = document.getElementById(`name_${contractCode}`).value.trim();
                    const odooClientId = document.getElementById(`odoo_${contractCode}`).value.trim();
                    const notes = document.getElementById(`notes_${contractCode}`).value.trim();
                    
                    // Salva solo se almeno un campo è compilato
                    if (contractName || odooClientId || notes) {
                        const updateData = {
                            contract_code: contractCode,
                            contract_name: contractName,
                            notes: notes
                        };
                        
                        if (odooClientId) {
                            updateData.odoo_client_id = parseInt(odooClientId);
                        }
                        
                        const response = await fetch('/api/cdr/update_contract', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(updateData)
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            successCount++;
                            document.getElementById(`status_${contractCode}`).textContent = '✅';
                            document.getElementById(`status_${contractCode}`).style.color = 'green';
                        } else {
                            errorCount++;
                            document.getElementById(`status_${contractCode}`).textContent = '❌';
                            document.getElementById(`status_${contractCode}`).style.color = 'red';
                        }
                    }
                } catch (error) {
                    errorCount++;
                    document.getElementById(`status_${contractCode}`).textContent = '❌';
                    document.getElementById(`status_${contractCode}`).style.color = 'red';
                }
                
                // Piccola pausa per non sovraccaricare il server
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            saveStatus.textContent = `Completato: ${successCount} salvati, ${errorCount} errori`;
            saveStatus.style.color = successCount > 0 ? 'green' : 'red';
            
            // Rimuovi il messaggio dopo 5 secondi
            setTimeout(() => {
                saveStatus.textContent = '';
            }, 5000);
        }
    </script>
<script src="assets/plugins/custom/datatables/datatables.bundle.js"></script>